# frozen_string_literal: true

class ScanUrlsController < ApplicationController
  require 'httparty'
  require 'pry'

  # include DeviseTokenAuth::Concerns::SetUserByToken

  def index
    @vulnerabilities = Vulnerability.all
  end

  def analize
    url = params[:url]
    analysis = Analysis.create(url: url, is_scan_completed: 0, analysis_date: DateTime.now, user_id: current_user.id)
    vulnerabilities = params[:vulnerabilities]
    #this one 
    #http://127.0.0.1:5000/scanner/start
    dockerInstance = 'http://vulnerabilityscanner_python_server_1:5000/scanner/start'
    result = HTTParty.post(dockerInstance,
                           body: {
                             idScann: analysis.id,
                             url: url,
                             vulnerabilities: vulnerabilities
                           }.to_json,
                           headers: { 'Content-Type' => 'application/json' })
    flash[:notice] = 'Starting analysis...' if result.code == 200
    redirect_to 'http://127.0.0.1:3000/'
  end
end
