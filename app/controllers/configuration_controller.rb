# frozen_string_literal: true

include BCrypt

class ConfigurationController < ApplicationController
  def show; end

  def edit
    @user = User.find(params[:id])
  end

  def update
    @user = User.find(params[:id])

    post_params = params.require(:user).permit(:email, :encrypted_password)

    password = Password.create(post_params[:encrypted_password])

    @user.update(email: post_params[:email], encrypted_password: password)

    redirect_to home_path
  end

  def destroy
    # TODO: After fixing the error when deleting user with analysis, try to change the global variables to local
    @user.destroy(@user.id)

    redirect_to home_path
    @user = current_user

    @analyses = Analysis.find_by_user_id(@user.id)
    @analyses.each do |analysis|
      @analysisTestsVulnerabilities = AnalysisTestsVulnerability.where("analyses_id = #{analysis.id}")
      @analysisTestsVulnerabilities.destroy if @analysisTestsVulnerabilities[0]
      @flaw = SecurityFlaw.find_by_analysis_id(analysis.id)
      @flaw.destroy if @flaw[0]
      analysis.destroy
    end

    @user.destroy

    redirect_to home_path
  end
end
